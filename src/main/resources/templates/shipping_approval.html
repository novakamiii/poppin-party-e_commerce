<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Poppin Party</title>
    <link rel="icon" th:href="@{/img/logowhite.png}" type="image/png" />
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet" />

    <style>
        .filter-section {
            display: flex;
            align-items: center;
            gap: 0.75em;
            margin: 2em 0 1.5em 0;
            padding: 0.75em 1.5em;
            background: #f8f8fa;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            font-family: 'Bebas Neue', Arial, sans-serif;
            font-size: 1.1em;
        }

        .filter-section label {
            font-weight: bold;
            letter-spacing: 1px;
            color: #333;
        }

        .filter-section select {
            padding: 0.4em 1.2em 0.4em 0.7em;
            border: 1px solid #bbb;
            border-radius: 5px;
            background: #fff;
            font-size: 1em;
            font-family: inherit;
            transition: border 0.2s;
        }

        .filter-section select:focus {
            outline: none;
            border-color: #ff6f61;
            box-shadow: 0 0 0 2px #ffe3e0;
        }
    </style>
</head>

<body>
    <header class="sticky-header">
        <div class="header-inner">
            <div class="logo">
                <a th:href="@{/admin/home}"><img th:src="@{/img/logowhite.png}" alt="logo" id="logo"></a>
            </div>
            <div class="search">
                <input type="text" class="search-input" placeholder="Search">
                <button class="search-button">
                    <img th:src="@{/img/search.png}" alt="search">
                </button>
            </div>
        </div>
    </header>
    <div class="filter-section">
        <label>Filter by status:</label>
        <select onchange="location = this.value;">
            <option th:value="@{/admin/transaction-approval?filter=all}" th:selected="${currentFilter == 'all'}">All
                Orders</option>
            <option th:value="@{/admin/transaction-approval?filter=PENDING}"
                th:selected="${currentFilter == 'PENDING'}">Pending
            </option>
            <option th:value="@{/admin/transaction-approval?filter=TO_RECEIVE}"
                th:selected="${currentFilter == 'TO_RECEIVE'}">
                To Receive</option>
            <option th:value="@{/admin/transaction-approval?filter=TO_SHIP}"
                th:selected="${currentFilter == 'TO_SHIP'}">Shipped
            </option>
            <option th:value="@{/admin/transaction-approval?filter=COMPLETED}"
                th:selected="${currentFilter == 'COMPLETED'}">Completed
            </option>
            <option th:value="@{/admin/transaction-approval?filter=CANCELLED}"
                th:selected="${currentFilter == 'CANCELLED'}">Cancelled
            </option>
        </select>
    </div>
    <table class="table-section">
        <tr>
            <th>ID</th>
            <th>User ID</th>
            <th>Username</th>
            <th>Order ID</th>
            <th>Address</th>
            <th>Item Name</th>
            <th>Quantity</th>
            <th>Amount</th>
            <th>Tracking Number</th>
            <th>Payment Method</th>
            <th>Shipping Status</th>
            <th>Order Date</th>
            <th>Actions</th>
        </tr>
        <tr th:each="payment : ${payments}" th:data-status="${payment.status}">
            <td th:text="${payment.id}"></td>
            <td th:text="${payment.user.id}"></td>
            <td th:text="${payment.user.username}"></td>
            <td th:text="${payment.order.id}"></td>
            <td th:text="${payment.user.address}"></td>
            <td th:text="${payment.itemName}"></td>
            <td th:text="${payment.quantity}"></td>
            <td th:text="${#numbers.formatDecimal(payment.amount, 1, 2)}"></td>
            <td th:text="${payment.order.trackingNumber}"></td>
            <td th:text="${payment.order.paymentMethod}"></td>
            <td th:text="${payment.status}"></td>
            <td th:text="${#dates.format(payment.order.orderDate, 'yyyy-MM-dd HH:mm')}"></td>
            <td>
                <div class="buttonst">
                    <a href="#" th:onclick="|updateStatus(${payment.order.id}, 'TO_SHIP')|" title="Mark as To Ship"
                        style="background: none; border: none; cursor: pointer; text-decoration: none;">üöö</a>
                    <a href="#" th:onclick="|updateStatus(${payment.order.id}, 'TO_RECEIVE')|"
                        title="Mark as To Receive"
                        style="background: none; border: none; cursor: pointer; text-decoration: none;">üì¶</a>
                    <a href="#" th:onclick="|updateStatus(${payment.order.id}, 'COMPLETED')|" title="Mark as Completed"
                        style="background: none; border: none; cursor: pointer; text-decoration: none;">‚úÖ</a>
                    <a href="#" th:onclick="|updateStatus(${payment.order.id}, 'CANCELLED')|" title="Mark as Cancelled"
                        style="background: none; border: none; cursor: pointer; text-decoration: none;">‚ùå</a>
                </div>
            </td>
        </tr>
    </table>

    <script th:inline="javascript">
        function updateStatus(orderId, newStatus) {
            fetch(`/admin/transaction/${orderId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ newStatus: newStatus })
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    response.text().then(text => alert('Error: ' + text));
                }
            });
        }
    </script>
</body>
<style>
    .buttons {
        display: flex;
        size: 10em;
    }
</style>

<script type="module">
    import { updateCartCounter } from '/js/ajax.js';

    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM fully loaded");
        updateCartCounter();
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.querySelector('.search-input');
        const searchButton = document.querySelector('.search-button');
        const transactionRows = document.querySelectorAll('.table-section tr:not(:first-child)');

        function performSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();

            transactionRows.forEach(row => {
                const orderId = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                const username = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                const itemName = row.querySelector('td:nth-child(5)').textContent.toLowerCase();
                const trackingNumber = row.querySelector('td:nth-child(8)').textContent.toLowerCase();

                const shouldShow = orderId.includes(searchTerm) ||
                    username.includes(searchTerm) ||
                    itemName.includes(searchTerm) ||
                    trackingNumber.includes(searchTerm);

                row.style.display = shouldShow ? '' : 'none';
            });
        }

        // Add debounce to prevent rapid firing
        let debounceTimer;
        function debounceSearch() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(performSearch, 300);
        }

        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('input', debounceSearch);

        // Also search when filter changes
        document.querySelector('.filter-section select').addEventListener('change', () => {
            setTimeout(performSearch, 500); // Wait for page to load new data
        });
    });
</script>

</html>
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Poppin Party</title>
    <link rel="icon" th:href="@{/img/logowhite.png}" type="image/png">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/style2.css}">
</head>

<body>
    <header class="sticky-header">
        <div class="header-inner">
            <div class="logo">
                <a th:href="@{/home}"><img th:src="@{/img/logowhite.png}" alt="logo" id="logo"></a>
            </div>
            <div class="search">
                <input type="text" class="search-input" placeholder="Search">
                <button class="search-button">
                    <img th:src="@{/img/search.png}" alt="search">
                </button>
            </div>
            <div class="header-actions">
                <div class="notif-button" th:if="${#authorization.expression('isAuthenticated()')}">
                    <img th:src="@{/img/notif.png}" alt="notification" id="notif">
                    <span id="notification-counter" class="notification-counter">0</span>
                    <div class="notif-dropdown">
                        <div class="notif-header">
                            <h3>Notifications</h3>
                            <button id="mark-all-read">Mark all as read</button>
                        </div>
                        <div class="notif-content" id="notif-content">
                            <!-- Notifications will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="account-button" data-protected data-protected-name="your account">
                    <a th:href="@{/account}">
                        <img th:src="@{/img/account.png}" alt="user" id="user">
                    </a>
                </div>
                <div class="cart-image" data-protected data-protected-name="your cart">
                    <a th:href="@{/cart}">
                        <img th:src="@{/img/cart.png}" alt="cart" id="cart">
                        <span id="cart-counter" class="cart-counter">0</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="product-page-wrapper">
            <div class="product-gallery">
                <div class="main-product-image-container">
                    <img src="" alt="Main Product Image" id="mainProductImage">
                </div>
                <div class="thumbnail-images" id="thumbnailContainer">
                    <!-- Thumbnails will be inserted here -->
                </div>
            </div>

            <div class="product-info">
                <h1 id="productTitle" class="product-page-title"></h1>
                <div class="product-rating">
                    <h2 class="stars" id="productStars">★★★★★</h2>
                    <span class="review-count" id="productReviews">(1,234 Reviews)</span>
                </div>

                <div class="out-of-stock-message" id="outOfStockMessage" style="display: none;">
                    <small>This product is currently out of stock</small>
                </div>
                <p class="product-page-price" id="productPrice"></p>

                <div class="quantity-selector">
                    <label for="product-qty" class="qty-label">QUANTITY:</label>
                    <button class="qty-btn minus">-</button>
                    <input type="number" id="product-qty" class="qty-input" value="1" min="1" max="99">
                    <button class="qty-btn plus">+</button>
                    <span class="stock-info" id="stockInfo"></span>
                </div>

                <div class="action-buttons">
                    <button class="add-to-cart-btn" id="addToCartBtn">ADD TO CART</button>
                    <button class="buy-now-btn" id="buyNowBtn">BUY NOW</button>
                </div>

                <div class="product-description">
                    <h3 class="section-heading">PRODUCT DESCRIPTION</h3>
                    <p id="productDescription"></p>
                </div>

                <div class="product-specs">
                    <h3 class="section-heading">PRODUCT SPECIFICATIONS</h3>
                    <ul id="productSpecs">
                        <!-- Specs like brand, material, etc. -->
                    </ul>
                </div>
            </div>
        </div>
        <div class="related-products-section">
            <h2 class="section-heading">YOU MAY ALSO LIKE</h2>
            <div class="productlist" id="related-products">
            </div> <!-- ✅ add this -->
        </div>
    </main>

    <footer>
        <div class="footer-container">
            <div class="footer-logo">
                <img th:src="@{/img/logowhite.png}" alt="Poppin Party Logo">
                <p>POPPIN PARTY</p>
                <p>CELEBRATION NEEDS</p>
            </div>
            <div class="footer-section">
                <h3>CUSTOMER SERVICE</h3>
                <ul>
                    <li>HELP CENTRE</li>
                    <li>CONTACT US</li>
                    <li>RETURN AND REFUND</li>
                    <li>POPPIN' GUARANTEE</li>
                    <li>FREE SHIPPING</li>
                    <li>PAYMENT METHODS</li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>ABOUT POPPIN' PARTY</h3>
                <ul>
                    <li>ABOUT US</li>
                    <li>PRIVACY POLICY</li>
                    <li>POPPIN' DEALS</li>
                    <li>MEDIA CONTACT</li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>PAYMENT</h3>
                <ul>
                    <li>GCASH</li>
                    <li>PAYPAL</li>
                    <li>CASHAPP</li>
                    <li>VISA</li>
                    <li>MASTERCARD</li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>LOGISTICS</h3>
                <ul>
                    <li>GOGO EXPRESS</li>
                    <li>NINJAVAN</li>
                    <li>UPS</li>
                    <li>FEDEX</li>
                    <li>LBC</li>
                    <li>DHL</li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>FOLLOW US</h3>
                <ul>
                    <li>FACEBOOK</li>
                    <li>INSTAGRAM</li>
                    <li>X</li>
                    <li>TIKTOK</li>
                </ul>
            </div>
        </div>
        <div class="copyright">
            © 2025 POPPIN PARTY CELEBRATION NEEDS™. ALL RIGHTS RESERVED
        </div>
    </footer>
</body>

<script>
    const productId = window.location.pathname.split("/").pop();
    const starsEl = document.getElementById('productStars');
    const reviewsEl = document.getElementById('productReviews');

    function loadOrGenerateRating(productId) {
        const ratingKey = `product-rating-${productId}`;
        const reviewKey = `product-reviews-${productId}`;

        let rating = localStorage.getItem(ratingKey);
        let reviewCount = localStorage.getItem(reviewKey);

        if (!rating || !reviewCount) {
            // Generate new values
            rating = Math.floor(Math.random() * 5) + 1; // 1 to 5 stars
            reviewCount = Math.floor(Math.random() * (5000 - 50 + 1)) + 50; // 50 to 5000

            // Store in localStorage
            localStorage.setItem(ratingKey, rating);
            localStorage.setItem(reviewKey, reviewCount);
        }

        return {
            rating: parseInt(rating),
            reviewCount: parseInt(reviewCount)
        };
    }

    const { rating, reviewCount } = loadOrGenerateRating(productId);

    // Display stars
    const filledStars = '★'.repeat(rating);
    const emptyStars = '☆'.repeat(5 - rating);
    starsEl.textContent = filledStars + emptyStars;

    // Display review count
    reviewsEl.textContent = `(${reviewCount.toLocaleString()} Reviews)`;


</script>


<script type="module">
    import { handleBuyNow, updateCartCounter } from '/js/ajax.js';
    import { authWrapper } from '/js/auth-utils.js';

    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM fully loaded");
        updateCartCounter();

        // Initialize elements
        const addToCartBtn = document.getElementById("addToCartBtn");
        const buyNowBtn = document.getElementById("buyNowBtn");
        const qtyInput = document.getElementById("product-qty");
        const minusBtn = document.querySelector('.qty-btn.minus');
        const plusBtn = document.querySelector('.qty-btn.plus');
        const productId = window.location.pathname.split("/").pop();

        // Quantity controls
        if (qtyInput && minusBtn && plusBtn) {
            minusBtn.addEventListener('click', () => {
                let currentQty = parseInt(qtyInput.value);
                if (currentQty > parseInt(qtyInput.min)) {
                    qtyInput.value = currentQty - 1;
                }
            });

            plusBtn.addEventListener('click', () => {
                let currentQty = parseInt(qtyInput.value);
                if (currentQty < parseInt(qtyInput.max)) {
                    qtyInput.value = currentQty + 1;
                }
            });
        }

        // Add to Cart
        if (addToCartBtn && qtyInput) {
            addToCartBtn.addEventListener("click", () => {
                authWrapper("add items to cart", async () => {
                    const rawProductId = window.location.pathname.split("/").pop();
                    const productId = parseInt(rawProductId);
                    const quantity = parseInt(qtyInput.value);

                    if (isNaN(productId)) {
                        alert("Invalid product ID");
                        return;
                    }

                    if (isNaN(quantity) || quantity <= 0) {
                        alert("Add to cart failed: Please enter a valid quantity!");
                        return;
                    }

                    try {
                        const response = await fetch("/api/cart/add", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/x-www-form-urlencoded"
                            },
                            body: `productId=${productId}&quantity=${quantity}`
                        });

                        if (response.redirected) {
                            alert('You must be logged in to access this feature!');
                        }

                        if (!response.ok) {
                            const errorMessage = await response.text();
                            throw new Error(errorMessage); s
                        }

                        const message = await response.text();
                        alert(message);
                        updateCartCounter();
                    } catch (err) {
                        alert("Add to cart failed: " + err.message);
                    }
                });
            });

        }

        // Buy Now
        if (buyNowBtn && qtyInput) {
            buyNowBtn.addEventListener("click", () => {
                authWrapper("complete your purchase", async () => {
                    const quantity = parseInt(qtyInput.value);
                    const productId = window.location.pathname.split("/").pop();

                    try {
                        await handleBuyNow(productId, quantity);
                    } catch (err) {
                        alert("Failed to proceed to checkout: " + err.message);
                    }
                });
            });
        }

        fetch(`/api/products/${productId}`)
            .then(res => {
                if (!res.ok) throw new Error('Failed to load product details');
                return res.json();
            })
            .then(product => {
                // Update DOM
                const title = document.getElementById('productTitle');
                const price = document.getElementById('productPrice');
                const stockInfo = document.getElementById('stockInfo');
                const image = document.getElementById('mainProductImage');

                title.textContent = product.itemName;
                price.textContent = `₱${product.price.toFixed(2)}`;
                stockInfo.textContent = `Available stock: ${product.stock}`;
                image.src = product.imageLoc;

                // ✅ Apply strikethrough and disable buttons if out of stock
                if (product.stock === 0) {
                    title.classList.add('strikethrough');
                    document.getElementById('outOfStockMessage').style.display = 'block';
                    document.getElementById('addToCartBtn').disabled = true;
                    document.getElementById('buyNowBtn').disabled = true;
                } else {
                    title.classList.remove('strikethrough');
                    document.getElementById('outOfStockMessage').style.display = 'none';
                    document.getElementById('addToCartBtn').disabled = false;
                    document.getElementById('buyNowBtn').disabled = false;
                }
            })
            .catch(err => {
                console.error('Product fetch error:', err);
                alert("Failed to load product info.");
            });
    });
</script>

<!-- Checking Auth -->
<script type="module">
    import { setupAuthProtectedElements } from '/js/auth-utils.js';

    document.addEventListener('DOMContentLoaded', () => {
        setupAuthProtectedElements();
    });
</script>

<!-- notification script -->
<script th:src="@{/js/notif.js}"></script>


<!--Related Products-->
<script type="module">
    import { createProductCardHTML } from '/js/ajax.js';

    const productList = document.querySelector('#related-products');

    fetch('/api/products')
        .then(res => res.json())
        .then(products => {
            const currentProductId = window.location.pathname.split('/').pop();

            // Shuffle helper
            function shuffle(array) {
                return array.sort(() => 0.5 - Math.random());
            }

            // Filter out current product, then shuffle, then take 4
            const randomRelated = shuffle(
                products.filter(product => product.id != currentProductId)
            ).slice(0, 4);

            randomRelated.forEach(product => {
                productList.insertAdjacentHTML('beforeend', createProductCardHTML(product));
            });
        })
        .catch(err => {
            console.error("Error fetching products:", err);
        });
</script>

<script>
    // Product Image Gallery Logic
    const mainProductImage = document.getElementById('mainProductImage');
    const thumbnails = document.querySelectorAll('.thumbnail');

    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', () => {
            // Remove active class from all thumbnails
            thumbnails.forEach(t => t.classList.remove('active'));
            // Add active class to the clicked thumbnail
            thumbnail.classList.add('active');
            // Change the main image source
            mainProductImage.src = thumbnail.getAttribute('data-full-src');
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const productId = window.location.pathname.split('/').pop();

        fetch(`/api/products/${productId}`)
            .then(res => res.json())
            .then(product => {
                document.getElementById('mainProductImage').src = product.imageLoc;
                document.getElementById('productTitle').textContent = product.itemName;
                document.getElementById('productPrice').textContent = `₱ ${product.price}`;
                document.getElementById('stockInfo').textContent = `${product.stock} pieces available`;
                document.getElementById('productDescription').textContent = product.description || 'No description available.';

                // Generate thumbnails (optional, if you store multiple images per product)
                const thumbnailContainer = document.getElementById('thumbnailContainer');
                thumbnailContainer.innerHTML = `<img src="${product.imageLoc}" class="thumbnail active" data-full-src="${product.imageLoc}">`;

                // Sample static specs (you can load dynamic fields instead if you store them)
                document.getElementById('productSpecs').innerHTML = `
          <li><span class="spec-label">Brand:</span> Poppin' Party</li>
          <li><span class="spec-label">Material:</span> Premium Material.</li>
          <li><span class="spec-label">Dimensions:</span> May Vary.</li>
        `;
            })
            .catch(err => {
                console.error('Failed to fetch product:', err);
                alert("Product not found.");
            });
    });
</script>
<script type="module">
    import { setupAuthProtectedElements } from '/js/auth-utils.js';

    document.addEventListener('DOMContentLoaded', () => {
        setupAuthProtectedElements();
    });
</script>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.querySelector('.search-input');
        const searchButton = document.querySelector('.search-button');

        function handleSearch() {
            const searchTerm = searchInput.value.trim();

            if (searchTerm) {
                // Redirect to see-more page with search query
                window.location.href = `/products/see-more?search=${encodeURIComponent(searchTerm)}`;
            } else {
                // Optional: Show error message or just redirect without search
                window.location.href = '/products/see-more';
            }
        }

        // Event listeners
        searchButton.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });
    });
</script>

</html>
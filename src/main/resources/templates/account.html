<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Poppin Party</title>
    <link rel="icon" th:href="@{/img/logowhite.png}" type="image/png">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/account.css}">
    <link rel="stylesheet" th:href="@{/css/order-status.css}">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>

<body>
    <header class="sticky-header">
        <div class="header-inner">
            <div class="logo">
                <a th:href="@{/home}"><img th:src="@{/img/logowhite.png}" alt="logo" id="logo"></a>
            </div>
            <div class="search">
                <input type="text" class="search-input" placeholder="Search">
                <button class="search-button">
                    <img th:src="@{/img/search.png}" alt="search">
                </button>
            </div>
            <div class="header-actions">
                <div class="notif-button">
                    <img th:src="@{/img/notif.png}" alt="notification" id="notif">
                    <span id="notification-counter" class="notification-counter">0</span>
                    <div class="notif-dropdown">
                        <div class="notif-header">
                            <h3>Notifications</h3>
                            <button id="mark-all-read">Mark all as read</button>
                        </div>
                        <div class="notif-content" id="notif-content">
                            <!-- Notifications will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="cart-image">
                    <a th:href="@{/cart}">
                        <img th:src="@{/img/cart.png}" alt="cart" id="cart">
                        <span id="cart-counter" class="cart-counter">0</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="account-dashboard-wrapper">
            <div class="sidebar">
                <div class="profile-header">
                    <!-- PROFILE IMAGE -->
                    <p>User Information</p>
                    <p class="username" th:text="${user?.username ?: 'No user detected'}">
                        placeholder
                    </p>
                    <div class="profile-image">
                        <img id="profilePic"
                            th:src="${user.imagePath} != null ? @{${user.imagePath}} : @{/img/default-profile.png}"
                            alt="Profile Picture" />
                    </div>
                    <div class="file-upload-container">
                        <form id="uploadProfileImageForm" enctype="multipart/form-data">
                            <div class="file-upload-wrapper">
                                <label class="file-upload-button" for="imageFile">Choose Photo</label>
                                <input type="file" id="imageFile" name="imageFile" accept="image/*" />
                                <div id="file-name">No file selected</div>
                            </div>
                            <button type="submit" class="save-button small">Upload</button>
                        </form>
                    </div>
                    <a th:href="@{'/logout'}" class="sidebar-button logout">LOG OUT</a>
                    <a th:href="@{'/order/status'}" class="sidebar-button order-status">ORDER STATUS</a>
                </div>

                <ul class="dashboard-menu">
                    <li><a href="#profile" class="active">My Account</a></li>
                </ul>
            </div>

            <div class="main-content">
                <section id="profile" class="dashboard-section active">
                    <h2 class="content-title">My Profile</h2>

                    <div th:if="${param.success}" class="alert alert-success">
                        Profile updated!
                    </div>

                    <div class="form-grid">
                        <form th:action="@{/account/update}" method="post">
                            <div class="form-group">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" id="username" name="username" th:value="${user.username}"
                                    class="form-input" readonly />
                                <small class="form-text">Username can only be changed once.</small>
                            </div>

                            <div class="form-group">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" id="name" name="name" th:value="${user.name}" class="form-input" />
                            </div>

                            <div class="form-group">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" id="email" name="email" th:value="${user.email}"
                                    class="form-input" />
                            </div>

                            <div class="form-group">
                                <label for="address" class="form-label">Address</label>
                                <input type="address" id="address" name="address" th:value="${user.address}"
                                    class="form-input" />
                            </div>

                            <div class="form-group">
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="tel" id="phone" name="phone" th:value="${user.phone}" class="form-input" />
                            </div>

                            <div class="form-group">
                                <label for="gender" class="form-label">Gender</label>
                                <select id="gender" name="gender" class="form-input">
                                    <option
                                        th:each="genderOpt : ${T(com.poppinparty.trinity.poppin_party_needs_alpha.Entities.User.Gender).values()}"
                                        th:value="${genderOpt.name()}" th:text="${genderOpt.name()}"
                                        th:selected="${genderOpt.name() == user.gender.name()}">
                                    </option>

                                </select>

                            </div>

                            <div class="form-group">
                                <label for="birthDate" class="form-label">Date of Birth</label>
                                <input type="date" id="birthDate" name="birthDate" th:value="${user.birthDate}"
                                    class="form-input" readonly />
                                <small class="form-text">You have already done KYC. Changing your birthday is not
                                    permitted.</small>
                            </div>

                            <button type="submit" class="save-button">Save</button>
                        </form>
                    </div>
                </section>
            </div>
        </div>
        </div>
    </main>
    <footer>
        <div class="footer-container">
            <div class="footer-logo">
                <img th:src="@{img/logowhite.png}" alt="Poppin Party Logo">
                <p>POPPIN PARTY</p>
                <p>CELEBRATION NEEDS</p>
            </div>
            <div class="footer-section">
                <h3>CUSTOMER SERVICE</h3>
                <li>HELP CENTRE</li>
                <li>CONTACT US</li>
                <li>RETURN AND REFUND</li>
                <li>POPPIN' GUARANTEE</li>
                <li>FREE SHIPPING</li>
                <li>PAYMENT METHODS</li>
            </div>
            <div class="footer-section">
                <h3>ABOUT POPPIN' PARTY</h3>
                <li>ABOUT US</li>
                <li>PRIVACY POLICY</li>
                <li>POPPIN' DEALS</li>
                <li>MEDIA CONTACT</li>
            </div>
            <div class="footer-section">
                <h3>PAYMENT</h3>
                <li>GCASH</li>
                <li>PAYPAL</li>
                <li>CASHAPP</li>
                <li>VISA</li>
                <li>MASTERCARD</li>
            </div>
            <div class="footer-section">
                <h3>LOGISTICS</h3>
                <li>GOGO EXPRESS</li>
                <li>NINJAVAN</li>
                <li>UPS</li>
                <li>FEDEX</li>
                <li>LBC</li>
                <li>DHL</li>
            </div>
            <div class="footer-section">
                <h3>FOLLOW US</h3>
                <li>FACEBOOK</li>
                <li>INSTAGRAM</li>
                <li>X</li>
                <li>TIKTOK</li>
            </div>
        </div>
        <div class="copyright">
            © 2025 POPPIN PARTY CELEBRATION NEEDS™. ALL RIGHTS RESERVED
        </div>
    </footer>

    <script th:src="@{/js/script.js}"></script>
    <script th:src="@{/js/account.js}"></script>

    <script>
        // Update the file name display when a file is selected
        document.getElementById('imageFile').addEventListener('change', function (e) {
            const fileNameDisplay = document.getElementById('file-name');
            if (this.files && this.files.length > 0) {
                fileNameDisplay.textContent = this.files[0].name;
                fileNameDisplay.style.color = '#333'; // Make text visible
            } else {
                fileNameDisplay.textContent = 'No file selected';
                fileNameDisplay.style.color = '#666'; // Gray out when no file
            }
        });

        // Form submission handler
        document.getElementById("uploadProfileImageForm").addEventListener("submit", function (e) {
            e.preventDefault();

            const fileInput = document.getElementById('imageFile');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert("Please select an image file first");
                return;
            }

            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.textContent;

            // Show loading state
            submitBtn.textContent = "Uploading...";
            submitBtn.disabled = true;

            fetch("/account/upload-image", {
                method: "POST",
                body: formData,
                credentials: "same-origin"
            })
                .then(res => {
                    if (!res.ok) throw new Error(res.statusText);
                    return res.json();
                })
                .then(data => {
                    // Update profile picture with cache-busting parameter
                    const profilePic = document.getElementById("profilePic");
                    profilePic.src = data.imageUrl + '?' + new Date().getTime();

                    // Reset file input and display
                    fileInput.value = '';
                    document.getElementById('file-name').textContent = 'No file selected';
                    document.getElementById('file-name').style.color = '#666';

                    submitBtn.textContent = "Uploaded!";
                    setTimeout(() => {
                        submitBtn.textContent = originalBtnText;
                    }, 2000);
                })
                .catch(err => {
                    console.error("Upload failed:", err);
                    alert("Upload failed. Please try again.");
                    submitBtn.textContent = originalBtnText;
                })
                .finally(() => {
                    submitBtn.disabled = false;
                });
        });
    </script>



    <script>
        (function () {
            const sidebarMenuLinks = document.querySelectorAll('.dashboard-menu a'); // instead of dashboardMenuLinks
            const dashboardSections = document.querySelectorAll('.dashboard-section');
            const orderStatusTabs = document.querySelectorAll('#order-status .status-tab');
            const orderItemLists = document.querySelectorAll('#order-status .order-item-list');

            sidebarMenuLinks.forEach(link => {
                link.addEventListener('click', function (event) {
                    event.preventDefault();
                    const targetId = this.getAttribute('href').substring(1); // Remove the '#'

                    // Deactivate all sections
                    dashboardSections.forEach(section => {
                        section.classList.remove('active');
                    });

                    // Activate the target section
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }

                    // Update active link in the sidebar
                    sidebarMenuLinks.forEach(item => item.classList.remove('active'));
                    this.classList.add('active');

                    // Handle order-status logic
                    if (targetId === 'order-status') {
                        orderStatusTabs.forEach(tab => tab.classList.remove('active'));
                        orderItemLists.forEach(list => list.style.display = 'none');

                        const initialTab = document.querySelector('#order-status .status-tab[data-tab="to-ship"]');
                        const initialContent = document.getElementById('to-ship');

                        if (initialTab && initialContent) {
                            initialTab.classList.add('active');
                            initialContent.style.display = 'block';
                        }

                        orderStatusTabs.forEach(tab => {
                            tab.addEventListener('click', () => {
                                orderStatusTabs.forEach(t => t.classList.remove('active'));
                                orderItemLists.forEach(content => content.style.display = 'none');

                                tab.classList.add('active');
                                const targetTab = tab.getAttribute('data-tab');
                                const targetContent = document.getElementById(targetTab);
                                if (targetContent) {
                                    targetContent.style.display = 'block';
                                }
                            });
                        });
                    }
                });
            });

            // Default visible section
            const initialSection = document.getElementById('profile');
            if (initialSection) {
                initialSection.classList.add('active');
            }

            if (window.location.hash === '#order-status') {
                const initialTab = document.querySelector('#order-status .status-tab[data-tab="to-ship"]');
                const initialContent = document.getElementById('to-ship');
                if (initialTab && initialContent) {
                    initialTab.classList.add('active');
                    initialContent.style.display = 'block';
                }
            }
        })();
    </script>

    <!-- notification script -->
    <script th:src="@{/js/notif.js}"></script>

    <script type="module">
        import { updateCartCounter } from '/js/ajax.js';

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded");
            updateCartCounter();
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.querySelector('.search-input');
            const searchButton = document.querySelector('.search-button');

            function handleSearch() {
                const searchTerm = searchInput.value.trim();

                if (searchTerm) {
                    // Redirect to see-more page with search query
                    window.location.href = `/products/see-more?search=${encodeURIComponent(searchTerm)}`;
                } else {
                    // Optional: Show error message or just redirect without search
                    window.location.href = '/products/see-more';
                }
            }

            // Event listeners
            searchButton.addEventListener('click', handleSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });
        });
    </script>

</body>

</html>
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poppin Party</title>
    <link rel="icon" th:href="@{/img/logowhite.png}" type="image/png">
    <link rel="stylesheet" th:href="@{/css/checkout.css}">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/style2.css}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
</head>

<body>
    <header class="sticky-header">
        <div class="header-inner">
            <div class="logo">
                <a th:href="@{/home}"><img th:src="@{/img/logowhite.png}" alt="logo" id="logo"></a>
            </div>
            <div class="search">
                <input type="text" class="search-input" placeholder="Search">
                <button class="search-button">
                    <img th:src="@{/img/search.png}" alt="search">
                </button>
            </div>
            <div class="header-actions">
                <div class="cart-image">
                    <a th:href="@{/cart}"><img th:src="@{/img/cart.png}" alt="cart" id="cart"></a>
                </div>
                <div class="account-button">
                    <a th:href="@{/account}">
                        <img th:src="@{/img/account.png}" alt="user" id="user">
                    </a>
                </div>
            </div>
        </div>
    </header>
    <main>
        <div class="categories-section">
            <p class="categories-title">CHECKOUT</p>
            <a id="restore-cart-btn" th:href="@{/order/restore-cart}" style="display:none;">Restore Cart</a>

            <!-- Notice will be inserted here by JavaScript -->
        </div>
        <br>
        <div class="checkout-cart-container">
            <div class="checkout-items">
            </div>
        </div>

        <br>
        <div class="checkout-details">
            <!-- SHIPPING -->
            <div class="detail-section shipping-section">
                <div class="section-header">
                    <h3>SHIPPING OPTION:</h3>
                </div>
                <ul class="shipping-options">
                    <li>
                        <input type="radio" id="standard" name="shipping" value="standard">
                        <label for="standard">Standard Shipping</label>
                    </li>
                    <li>
                        <input type="radio" id="express" name="shipping" value="express">
                        <label for="express">Express Shipping</label>
                    </li>
                    <li>
                        <input type="radio" id="overnight" name="shipping" value="overnight">
                        <label for="overnight">Overnight Shipping</label>
                    </li>
                </ul>
            </div>

            <div class="detail-section address-section">
                <div class="section-header">
                    <h3>ADDRESS:</h3>
                </div>
                <p th:text="${address}"></p>
            </div>

            <div class="detail-section payment-section">
                <div class="section-header">
                    <h3>PAYMENT OPTION:</h3>
                </div>
                <ul class="payment-options">
                    <li>
                        <input type="radio" id="cod" name="payment" value="cod">
                        <label for="cod">Cash on Delivery</label>
                    </li>

                    <li>
                        <input type="radio" id="creditcard" name="payment" value="creditcard">
                        <label for="creditcard">Credit Card</label>
                    </li>
                    <li>
                        <input type="radio" id="gcash" name="payment" value="gcash">
                        <label for="gcash">GCash</label>
                    </li>
                    <li>
                        <input type="radio" id="banktransfer" name="payment" value="banktransfer">
                        <label for="banktransfer">Bank Transfer</label>
                    </li>
                </ul>
            </div>


            <div class="detail-section order-summary">
                <h3>ORDER SUMMARY</h3>
                <div class="summary-item">
                    <span>MERCHANDISE SUBTOTAL</span>
                    <span>₱885.00</span>
                </div>
                <div class="summary-item">
                    <span>SHIPPING SUBTOTAL</span>
                    <span>₱75.00</span>
                </div>
                <div class="summary-item">
                    <span>VALUE ADDED TAX (12%)</span>
                    <span>₱106.20</span>
                </div>
                <div class="summary-item total">
                    <span>TOTAL PAYMENT:</span>
                    <span>₱1066.20</span>
                </div>
            </div>
        </div>
        <div>
            <div class="checkout-container">
                <form id="checkoutForm" method="post" action="/order/place" onsubmit="return validateCheckoutForm()">
                    <input type="hidden" name="shippingOption" id="shippingOptionInput">
                    <input type="hidden" name="paymentMethod" id="paymentMethodInput">
                    <input type="hidden" name="itemsJson" id="itemsJsonInput" />
                    <button type="submit" class="checkout-button">PLACE ORDER</button>
                </form>
            </div>
        </div>
        <br>
        <br>
        <br>


    </main>



    <footer>
        <div class="footer-container">
            <div class="footer-logo">
                <img th:src="@{/img/logowhite.png}" alt="Poppin Party Logo">
                <p>POPPIN PARTY</p>
                <p>CELEBRATION NEEDS</p>
            </div>
            <div class="footer-section">
                <h3>CUSTOMER SERVICE</h3>
                <ul>
                    <li>HELP CENTRE</li>
                    <li>CONTACT US</li>
                    <li>RETURN AND REFUND</li>
                    <li>POPPIN' GUARANTEE</li>
                    <li>FREE SHIPPING</li>
                    <li>PAYMENT METHODS</li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>ABOUT POPPIN' PARTY</h3>
                <ul>
                    <li>ABOUT US</li>
                    <li>PRIVACY POLICY</li>
                    <li>POPPIN' DEALS</li>
                    <li>MEDIA CONTACT</li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>PAYMENT</h3>
                <ul>
                    <li>GCASH</li>
                    <li>PAYPAL</li>
                    <li>CASHAPP</li>
                    <li>VISA</li>
                    <li>MASTERCARD</li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>LOGISTICS</h3>
                <ul>
                    <li>GOGO EXPRESS</li>
                    <li>NINJAVAN</li>
                    <li>UPS</li>
                    <li>FEDEX</li>
                    <li>LBC</li>
                    <li>DHL</li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>FOLLOW US</h3>
                <ul>
                    <li>FACEBOOK</li>
                    <li>INSTAGRAM</li>
                    <li>X</li>
                    <li>TIKTOK</li>
                </ul>
            </div>
        </div>
        <div class="copyright">
            © 2025 POPPIN PARTY CELEBRATION NEEDS™. ALL RIGHTS RESERVED
        </div>
    </footer>
</body>

<script type="module">
    import { renderCheckoutItems, updateSummary } from '/js/checkout-utils.js';

    document.addEventListener("DOMContentLoaded", () => {
        // Initialize form values
        const shippingInput = document.getElementById("shippingOptionInput");
        const paymentInput = document.getElementById("paymentMethodInput");

        const savedShipping = localStorage.getItem("shippingOption") || "standard";
        const savedPayment = localStorage.getItem("paymentMethod") || "cod";

        // Clean up checkoutItems on page load
        let checkoutItems = JSON.parse(localStorage.getItem("checkoutItems") || "[]");
        checkoutItems = checkoutItems.map(item => ({
            ...item,
            productId: item.productId ?? item.id
        }));
        localStorage.setItem("checkoutItems", JSON.stringify(checkoutItems));

        shippingInput.value = savedShipping;
        paymentInput.value = savedPayment;

        // Pre-select visible shipping radio based on saved value
        const shippingRadio = document.querySelector(`input[name="shipping"][value="${savedShipping}"]`);
        if (shippingRadio) shippingRadio.checked = true;

        // Pre-select popup-based payment radio if present
        const paymentRadio = document.querySelector(`input[name="payment"][value="${savedPayment}"]`);
        if (paymentRadio) paymentRadio.checked = true;

        // Load cart items
        const storedItems = JSON.parse(localStorage.getItem("checkoutItems") || "[]");
        if (storedItems.length > 0) {
            renderCheckoutItems(".checkout-items", updateSummary);
        } else {
            fetch('/api/cart')
                .then(response => response.json())
                .then(items => {
                    localStorage.setItem("checkoutItems", JSON.stringify(items));
                    document.getElementById("itemsJsonInput").value = JSON.stringify(items);
                    renderCheckoutItems(".checkout-items", updateSummary);
                })
                .catch(err => console.error("Cart load error:", err));
        }

        // Listen to shipping option changes (now visible)
        document.addEventListener("change", function (e) {
            if (e.target.name === "shipping") {
                const selected = e.target;
                const label = document.querySelector(`label[for="${selected.id}"]`)?.textContent;
                shippingInput.value = selected.value;
                localStorage.setItem("shippingOption", selected.value);
                updateSummary();
            }
        });

        // Listen to visible payment radio changes
        document.addEventListener("change", function (e) {
            if (e.target.name === "payment") {
                const selected = e.target;
                const label = document.querySelector(`label[for="${selected.id}"]`)?.textContent;
                paymentInput.value = selected.value;
                localStorage.setItem("paymentMethod", selected.value);
                updateSummary();
            }
        });

        document.getElementById("checkoutForm")?.addEventListener("submit", async function (e) {
            let items = [];
            try {
                const response = await fetch('/api/cart');
                items = await response.json();
                // Ensure productId is set for every item (fallback to id if needed)
                items = items.map(item => ({
                    ...item,
                    productId: item.productId ?? item.id
                }));
                // Update localStorage so validateCheckoutForm() and summary use correct data
                localStorage.setItem("checkoutItems", JSON.stringify(items));
            } catch (err) {
                alert("Failed to load cart items. Please try again.");
                e.preventDefault();
                return;
            }
            document.getElementById("itemsJsonInput").value = JSON.stringify(items);
            if (!validateCheckoutForm()) {
                e.preventDefault();
            }
        });
    });

    function setupPopup(type, selectCallback) {
        const openBtn = document.getElementById(`open${type.charAt(0).toUpperCase() + type.slice(1)}Popup`);
        const popup = document.getElementById(`${type}Popup`);
        if (!openBtn || !popup) return;

        const closeBtn = popup.querySelector('.close-button');
        const selectBtn = popup.querySelector('button');

        openBtn.addEventListener('click', () => popup.style.display = 'flex');
        closeBtn?.addEventListener('click', () => popup.style.display = 'none');
        window.addEventListener('click', (e) => e.target === popup && (popup.style.display = 'none'));

        selectBtn?.addEventListener('click', () => {
            const selected = popup.querySelector(`input[name="${type}"]:checked`);
            if (selected) {
                const label = document.querySelector(`label[for="${selected.id}"]`)?.textContent;
                selectCallback(selected.value, label || selected.value);
                popup.style.display = 'none';
            } else {
                alert(`Please select a ${type} option.`);
            }
        });
    }

    // function validateCheckoutForm() {
    //     const items = JSON.parse(localStorage.getItem("checkoutItems") || "[]");
    //     if (items.length === 0) {
    //         alert("Your cart is empty! Please add items before checking out.");
    //         return false;
    //     }
    //     return true;
    // }
</script>


</html>